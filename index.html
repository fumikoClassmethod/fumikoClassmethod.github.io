<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>UXåŸºç¤ğŸ“–</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <style>
    .btn-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 18px;
      margin-bottom: 8px;
      flex-direction: row;
    }
    .btn-main {
      flex: 1 1 0;
      width: auto;
      min-width: 120px;
      font-size: 1.15em;
      padding: 12px 0;
      background: linear-gradient(90deg, #4f8cff 0%, #38c9d6 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      letter-spacing: 0.05em;
      transition: background 0.2s;
      text-align: center;
      margin: 0;
    }
    .btn-main:hover {
      background: linear-gradient(90deg, #357ae8 0%, #2bb3b3 100%);
    }
    .btn-back {
      background: #e0e0e0 !important;
      color: #333 !important;
      font-weight: normal;
      transition: background 0.2s;
    }
    .btn-back:hover {
      background: #cccccc !important;
    }
    @media (max-width: 600px) {
      .btn-row { flex-direction: column; gap: 10px; }
      .btn-main, .btn-back { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>UXåŸºç¤ğŸ“–</h1>
    <div class="progress-bar-bg"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    <div id="startArea">
      è©¦é¨“æ™‚é–“ï¼ˆåˆ†ï¼‰: <input type="number" id="examTime" value="50" min="1">
      <button onclick="startExam()">è©¦é¨“é–‹å§‹</button>
    </div>
    <div id="timer"></div>
    <div id="questionArea" style="display:none;"></div>
    <div id="result"></div>
  </div>
  <script src="questions.js"></script>
  <script>
    let timerInterval;
    let timeLeft = 0;
    let current = 0;
    let userAnswers = [];
    let score = 0;
    let answerShown = [];

    function startExam() {
      document.getElementById('result').textContent = "";
      document.getElementById('startArea').style.display = "none";
      const examTime = parseInt(document.getElementById('examTime').value);
      if (isNaN(examTime) || examTime < 1) {
        alert("1åˆ†ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      timeLeft = examTime * 60;
      current = 0;
      userAnswers = [];
      score = 0;
      answerShown = [];
      document.getElementById('questionArea').style.display = "";
      document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${examTime}:00`;
      showQuestion();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      timeLeft--;
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('timer').textContent = `æ®‹ã‚Šæ™‚é–“: ${min}:${sec.toString().padStart(2, '0')}`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        document.getElementById('timer').textContent = "æ™‚é–“åˆ‡ã‚Œï¼";
        showResult();
      }
    }

    function showQuestion() {
      if (current >= questions.length) {
        clearInterval(timerInterval);
        showResult();
        return;
      }
      // é€²æ—ãƒãƒ¼
      document.getElementById('progressBar').style.width = ((current) / questions.length * 100) + "%";
      const q = questions[current];
      const area = document.getElementById('questionArea');
      area.innerHTML = `<div class="card"><div class="question">Q${current+1} / ${questions.length}<br>${q.question}</div></div>`;
      const choicesDiv = document.createElement('div');
      choicesDiv.className = "choices";
      q.choices.forEach((choice, cidx) => {
        const id = `q${current}_c${cidx}`;
        choicesDiv.innerHTML += `
          <label>
            <input type="checkbox" name="q${current}" value="${cidx+1}" id="${id}">
            <span>${choice}</span>
          </label>
        `;
      });
      area.appendChild(choicesDiv);

      // é¸æŠè‚¢ã®å¾©å…ƒ
      if (userAnswers[current]) {
        userAnswers[current].forEach(val => {
          const el = document.querySelector(`input[name="q${current}"][value="${val}"]`);
          if (el) el.checked = true;
        });
      }

      // ã€Œå›ç­”ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã¿
      if (!answerShown[current]) {
        const btnRow = document.createElement('div');
        btnRow.className = "btn-row";
        const btn = document.createElement('button');
        btn.textContent = "å›ç­”ã‚’è¦‹ã‚‹";
        btn.className = "btn-main";
        btn.onclick = showAnswer;
        btnRow.appendChild(btn);
        area.appendChild(btnRow);
      } else {
        showAnswer(true); // å¾©å…ƒè¡¨ç¤º
      }
    }

    function showAnswer(isRestore) {
      // é¸æŠè‚¢ã‚’å–å¾—
      const selected = Array.from(document.querySelectorAll(`input[name="q${current}"]:checked`))
                            .map(el => el.value);
      userAnswers[current] = selected;
      answerShown[current] = true;
      // ã‚¹ã‚³ã‚¢å†è¨ˆç®—ï¼ˆå¸¸ã«å…¨å•åˆ†ã‚’å†è¨ˆç®—ï¼‰
      score = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] && arraysEqual((userAnswers[i]||[]).sort(), questions[i].answer.sort())) {
          score++;
        }
      }
      const area = document.getElementById('questionArea');
      let html = area.innerHTML;
      html += `<div class="answer-block">
        <span class="answer-correct">æ­£è§£: ${questions[current].answer.join(", ")}</span>
        <span class="answer-user">ã‚ãªãŸã®å›ç­”: ${selected.length ? selected.join(", ") : "æœªå›ç­”"}</span>
      </div>`;
      if (questions[current].explanation) {
        html += `<div class="explanation">è§£èª¬: ${questions[current].explanation}</div>`;
      }
      if (questions[current].gpt_reason) {
        html += `<div class="gpt-reason"><strong>ChatGPTã®è¦‹è§£:</strong> ${questions[current].gpt_reason}</div>`;
      }
      area.innerHTML = html;

      // ã€Œæˆ»ã‚‹ã€ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ï¼ˆæ¨ªä¸¦ã³ã§1è¡Œã€æˆ»ã‚‹ãŒå·¦ï¼‰
      const btnRow = document.createElement('div');
      btnRow.className = "btn-row";
      if (current > 0) {
        const backBtn = document.createElement('button');
        backBtn.textContent = "æˆ»ã‚‹";
        backBtn.className = "btn-main btn-back";
        backBtn.onclick = function() {
          current--;
          showQuestion();
        };
        btnRow.appendChild(backBtn);
      }
      const nextBtn = document.createElement('button');
      nextBtn.textContent = (current === questions.length - 1) ? "çµæœã‚’è¦‹ã‚‹" : "æ¬¡ã¸";
      nextBtn.className = "btn-main";
      nextBtn.onclick = function() {
        current++;
        showQuestion();
      };
      btnRow.appendChild(nextBtn);

      area.appendChild(btnRow);

      // é€²æ—ãƒãƒ¼æ›´æ–°
      document.getElementById('progressBar').style.width = ((current+1) / questions.length * 100) + "%";
    }

    function showResult() {
      document.getElementById('questionArea').style.display = "none";
      document.getElementById('progressBar').style.width = "100%";
      let resultHtml = `<h2 style="color:#4f8cff;text-align:center;">è¨ºæ–­çµæœ</h2>`;
      resultHtml += `<div style="font-size:1.3em;text-align:center;margin-bottom:1em;"><strong>ã‚ãªãŸã®å¾—ç‚¹: ${score} / ${questions.length}</strong></div>`;
      questions.forEach((q, idx) => {
        const selected = userAnswers[idx] || [];
        const isCorrect = arraysEqual(selected.sort(), q.answer.sort());
        resultHtml += `<div class="card"><div><strong>Q${idx+1}:</strong> ${isCorrect ? "<span style='color:#1eaf5a'>æ­£è§£</span>" : "<span style='color:#d00'>ä¸æ­£è§£</span>"}</div>`;
        resultHtml += `<div style="margin-top:0.5em;">${q.question}</div>`;
        resultHtml += `<div class="answer-block">
          <span class="answer-correct">æ­£è§£: ${q.answer.join(", ")}</span>
          <span class="answer-user">ã‚ãªãŸã®å›ç­”: ${selected.length ? selected.join(", ") : "æœªå›ç­”"}</span>
        </div>`;
        if (q.explanation) {
          resultHtml += `<div class="explanation">è§£èª¬: ${q.explanation}</div>`;
        }
        if (q.gpt_reason) {
          resultHtml += `<div class="gpt-reason"><strong>ChatGPTã®è¦‹è§£:</strong> ${q.gpt_reason}</div>`;
        }
        resultHtml += `</div>`;
      });
      document.getElementById('result').innerHTML = resultHtml;
    }

    function arraysEqual(a, b) {
      return a.length === b.length && a.every((v, i) => v === b[i]);
    }
  </script>
</body>
</html>